name: FM Architecture Gate (Completeness + Agent State)

# CI CLASSIFICATION: Hard Gate
# Purpose: Enforces FM architecture completeness (100%) and drift status (NONE) for FM Agent role only
# Failure Semantics:
#   - Architecture incomplete ‚Üí Block merge + agent must fix/escalate/halt
#   - Drift detected ‚Üí Block merge + escalation
#   - Infrastructure failures ‚Üí Explicit infra-failure signal ‚Üí Success + Comment
# Timeout: 10 minutes (file-based validation only)
# Applicability: FM Agent role ONLY (skipped for Builder/Governance roles)
# See: .github/CI_CLASSIFICATION.md

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

# Explicit, least-privilege permissions
permissions:
  contents: read
  pull-requests: write

jobs:
  fm-architecture-gate:
    name: Enforce Architecture 100% + Block Agent Conclusion
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Agent Role
        id: agent-role
        run: |
          echo "üîç Detecting agent role for gate applicability..."
          
          ROLE=""
          
          # Check for explicit PR label (highest precedence)
          LABELS="${{ github.event.pull_request.labels }}"
          if echo "$LABELS" | grep -q "agent-role:"; then
            ROLE=$(echo "$LABELS" | grep -oP 'agent-role:\K[a-z]+' | head -1)
            echo "‚úÖ Role from PR label: $ROLE"
          # Check .agent file (second precedence)
          elif [ -f ".agent" ] && grep -qE "^role:" ".agent"; then
            ROLE=$(grep -E "^role:" .agent | head -1 | cut -d: -f2 | tr -d ' "' | tr '[:upper:]' '[:lower:]')
            echo "‚úÖ Role from .agent file: $ROLE"
          # Check PR title prefix (third precedence)
          elif [[ "${{ github.event.pull_request.title }}" =~ ^\[(Builder|Governance|FM|builder|governance|fm)\] ]]; then
            ROLE=$(echo "${{ github.event.pull_request.title }}" | grep -oP '^\[\K[^\]]+' | tr '[:upper:]' '[:lower:]')
            echo "‚úÖ Role from PR title: $ROLE"
          # Infer from PR content (fourth precedence - governance keywords)
          elif [[ "${{ github.event.pull_request.title }}" =~ [Gg]overnance ]] || [[ "${{ github.event.pull_request.title }}" =~ [Aa]lign ]]; then
            ROLE="governance"
            echo "‚úÖ Role inferred from PR title keywords: $ROLE"
          # Default to FM repository's primary role
          else
            ROLE="fm"
            echo "‚ÑπÔ∏è Using default role for FM repository: $ROLE"
          fi
          
          echo "role=$ROLE" >> $GITHUB_OUTPUT
          echo ""
          echo "**Detected Agent Role: $ROLE**"
      
      - name: Check Gate Applicability
        id: applicability
        run: |
          ROLE="${{ steps.agent-role.outputs.role }}"
          
          echo "üîç Checking FM Architecture Gate applicability..."
          echo "Agent Role: $ROLE"
          echo ""
          
          # FM Architecture Gate applies ONLY to FM Agent role
          if [ "$ROLE" = "fm" ]; then
            echo "‚úÖ FM Architecture Gate is APPLICABLE for FM Agent role"
            echo "applicable=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è FM Architecture Gate is NOT APPLICABLE for $ROLE role"
            echo ""
            echo "**Gate Applicability Matrix (Canonical):**"
            echo "- Builder role: ‚ùå Not applicable"
            echo "- Governance role: ‚ùå Not applicable"
            echo "- FM role: ‚úÖ Applicable"
            echo ""
            echo "This gate enforces FM architecture completeness requirements."
            echo "It does NOT apply to Builder or Governance Administrator work."
            echo ""
            echo "**Reference**: governance/alignment/AGENT_ROLE_GATE_APPLICABILITY_REFERENCE.md"
            echo "applicable=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Skip Gate (Not Applicable)
        if: steps.applicability.outputs.applicable == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const role = '${{ steps.agent-role.outputs.role }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚è≠Ô∏è **FM Architecture Gate - Not Applicable**
              
              **Detected Agent Role**: \`${role}\`
              
              FM Architecture Gate applies **only** to FM Agent work.
              
              This PR is performing **${role}** work, so architecture completeness requirements do not apply.
              
              ---
              
              **Gate Applicability (Canonical)**:
              
              | Agent Role         | FM Architecture Gate |
              |--------------------|----------------------|
              | Builder            | ‚ùå Not Applicable     |
              | Governance Admin   | ‚ùå Not Applicable     |
              | **FM Agent**       | ‚úÖ Applicable         |
              
              ---
              
              **Why This Gate Skips**:
              
              FM Architecture Gate enforces:
              - Architecture build artifacts exist
              - Architecture completeness = 100%
              - Drift status = NONE
              
              These requirements apply to FM Agent work that modifies FM's own architecture and implementation.
              
              They do **not** apply to:
              - Governance alignment work (governance agent)
              - Builder work in ISMS modules (builder agent)
              
              ---
              
              **References**:
              - [Agent Role Gate Applicability](../governance/alignment/AGENT_ROLE_GATE_APPLICABILITY_REFERENCE.md)
              - [PR Gate Release Checklists](../governance/alignment/PR_GATE_RELEASE_CHECKLISTS_REFERENCE.md)
              
              **Gate Status**: ‚úÖ Pass (not applicable)
              `
            })
      
      - name: Verify .agent exists (entry gate)
        if: steps.applicability.outputs.applicable == 'true'
        run: |
          if [ ! -f ".agent" ]; then
            echo "‚ùå GOVERNANCE BLOCK: .agent is missing."
            echo "Agents may not act without a valid .agent contract."
            exit 1
          fi
          echo "‚úÖ .agent present"

      - name: Verify BUILD_ACTIVE exists
        if: steps.applicability.outputs.applicable == 'true'
        run: |
          if [ ! -f "architecture/BUILD_ACTIVE" ]; then
            echo "‚ùå ARCHITECTURE BLOCK: architecture/BUILD_ACTIVE is missing."
            echo "FM must declare the active build id."
            echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
            exit 1
          fi
          echo "‚úÖ BUILD_ACTIVE present"

      - name: Resolve active build id
        if: steps.applicability.outputs.applicable == 'true'
        id: build
        run: |
          BUILD_ID="$(cat architecture/BUILD_ACTIVE | tr -d '\r' | tr -d '\n')"
          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå ARCHITECTURE BLOCK: BUILD_ACTIVE is empty."
            echo "FM must set a non-empty build id."
            echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
            exit 1
          fi

          BUILD_DIR="architecture/builds/${BUILD_ID}"
          if [ ! -d "$BUILD_DIR" ]; then
            echo "‚ùå ARCHITECTURE BLOCK: Build directory not found: $BUILD_DIR"
            echo "FM must compile architecture into architecture/builds/<build-id>/"
            echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
            exit 1
          fi

          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"
          echo "build_dir=$BUILD_DIR" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Active build: $BUILD_ID"

      - name: Verify required architecture artifacts exist
        if: steps.applicability.outputs.applicable == 'true'
        run: |
          BUILD_DIR="${{ steps.build.outputs.build_dir }}"
          REQUIRED_FILES=(
            "${BUILD_DIR}/compilation.md"
            "${BUILD_DIR}/validation.md"
            "${BUILD_DIR}/drift-report.md"
          )

          for FILE in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$FILE" ]; then
              echo "‚ùå ARCHITECTURE BLOCK: Missing required artifact: $FILE"
              echo "Architecture must mirror a complete working app."
              echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
              exit 1
            fi
          done

          echo "‚úÖ Required artifacts present"

      - name: Enforce Architecture Completeness = 100%
        if: steps.applicability.outputs.applicable == 'true'
        run: |
          BUILD_DIR="${{ steps.build.outputs.build_dir }}"
          VALIDATION="${BUILD_DIR}/validation.md"

          REQUIRED_MARKERS=(
            "ARCHITECTURE_COMPLETENESS: 100%"
            "CHECKLIST_STATUS: PASS"
            "DRIFT_STATUS: NONE"
            "CANONICAL_CHECKLIST_REF:"
          )

          for MARKER in "${REQUIRED_MARKERS[@]}"; do
            if ! grep -q "$MARKER" "$VALIDATION"; then
              echo "‚ùå ARCHITECTURE BLOCK: validation.md missing marker: $MARKER"
              echo "FM must produce a PASS/100% validation report with canonical checklist reference."
              echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
              exit 1
            fi
          done

          echo "‚úÖ validation.md declares 100% + PASS + canonical reference"

      - name: Enforce Drift Report = NONE
        if: steps.applicability.outputs.applicable == 'true'
        run: |
          BUILD_DIR="${{ steps.build.outputs.build_dir }}"
          DRIFT="${BUILD_DIR}/drift-report.md"

          if ! grep -q "DRIFT_STATUS: NONE" "$DRIFT"; then
            echo "‚ùå DRIFT BLOCK: drift-report.md does not declare DRIFT_STATUS: NONE"
            echo "Open drift means architecture is incomplete."
            echo "Agent state: ESCALATE / HALT. Never conclude."
            exit 1
          fi

          echo "‚úÖ Drift status is NONE"


      - name: Enforce "No Agent Conclusion While Incomplete" (hard banner)
        if: steps.applicability.outputs.applicable == 'true'
        run: |
          echo "‚úÖ FM ARCHITECTURE GATE PASSED"
          echo "Architecture completeness is declared 100% and drift is NONE."
          echo "Only now may agents proceed toward completion/hand-over."
      
      - name: Generate Infrastructure Failure Report
        if: always() && env.INFRA_FAILURE != ''
        run: |
          mkdir -p /tmp/infra-failure
          cat > /tmp/infra-failure/report.json << 'EOF'
          {
            "failure_type": "infrastructure",
            "workflow": "fm-architecture-gate",
            "job": "fm-architecture-gate",
            "failure_category": "${{ env.INFRA_FAILURE }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "recommended_action": "investigate",
            "details": {
              "workflow_run": "${{ github.run_id }}"
            }
          }
          EOF
      
      - name: Upload Infrastructure Failure Artifact
        if: always() && env.INFRA_FAILURE != ''
        uses: actions/upload-artifact@v4
        with:
          name: infra-failure-report-fm-architecture
          path: /tmp/infra-failure/report.json
          retention-days: 30
      
      - name: Comment Infrastructure Failure on PR
        if: always() && env.INFRA_FAILURE != '' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const failureType = process.env.INFRA_FAILURE;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚ö†Ô∏è **Infrastructure Failure Detected**
              
              **Workflow**: FM Architecture Gate  
              **Failure Type**: \`${failureType}\`  
              **Timestamp**: ${new Date().toISOString()}
              
              This is **NOT a code failure**. The workflow encountered an infrastructure issue.
              
              **Your code changes are NOT blocked by this failure**
              
              **Infrastructure Failure Report**: Download artifact \`infra-failure-report-fm-architecture\`
              `
            })
      
      - name: Mark Success Despite Infrastructure Failure
        if: always() && env.INFRA_FAILURE != ''
        run: |
          echo "‚úÖ Job marked as success - Infrastructure failure (not code failure)"
          exit 0
      
      - name: Workflow Success
        if: success()
        run: |
          echo "‚úÖ FM Architecture Gate completed successfully"
          exit 0
