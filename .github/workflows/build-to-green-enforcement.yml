name: Build-to-Green Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

# Explicit, least-privilege permissions
# Required for governance feedback (PR comments, issues)
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build-to-green:
    name: Enforce Build-to-Green
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Enforce No Test Dodging
        run: |
          echo "üîç Scanning for forbidden test-dodging patterns..."

          if grep -R --line-number -E "\.skip|\.(only)\b|jest\.skip|describe\.only|it\.only|\|\| true" .; then
            echo "‚ùå Test dodging detected."
            echo "Use governed QA parking or DP-RED instead."
            exit 1
          fi

          echo "‚úÖ No test dodging patterns found."

      - name: Run Test Suite
        run: |
          echo "‚ñ∂Ô∏è Running test suite..."
          npm test

      - name: Check for RED tests
        run: |
          echo "üîç Checking for RED test results..."

          if [ -f ./qa/design_phase/DP_RED_REGISTRY.json ]; then
            echo "‚ÑπÔ∏è DP-RED registry found."

            PHASE_FILE="./qa/phase/current_phase.txt"

            if [ ! -f "$PHASE_FILE" ]; then
              echo "‚ùå Phase file missing. Cannot determine QA phase."
              exit 1
            fi

            CURRENT_PHASE=$(cat "$PHASE_FILE")

            echo "Current phase: $CURRENT_PHASE"

            if [ "$CURRENT_PHASE" = "BUILD_TO_GREEN" ]; then
              echo "‚ùå DP-RED present during Build-to-Green phase."
              exit 1
            fi

            echo "‚úÖ DP-RED allowed for current phase."
          else
            echo "‚ÑπÔ∏è No DP-RED registry present."
          fi

      - name: Governance Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚úÖ **Build-to-Green Check Completed**

              - No test dodging detected
              - Test suite executed
              - DP-RED handled according to governance rules

              ‚ö†Ô∏è Reminder:
              - DP-RED must be cleared before Build-to-Green
              - All failures are treated as catastrophic until prevented permanently
              `
            })

      - name: Failure Handling
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Catastrophic Failure ‚Äî Build-to-Green Enforcement",
              body: `
              ‚ùå **Catastrophic Failure Detected**

              This failure blocked Build-to-Green enforcement.

              Required actions:
              1. Pause work
              2. Identify root cause
              3. Implement permanent prevention
              4. Update QA and governance if required
              5. Propagate lessons learned to all repos

              Repeat occurrence of this failure is classified as **double-catastrophic**.
              `
            })
