name: Build-to-Green Enforcement

# CI CLASSIFICATION: Hard Gate
# Purpose: Enforces Build-to-Green contract by running test suite and checking for test dodging
# Failure Semantics:
#   - Test failures â†’ Code failure â†’ Block merge
#   - Test dodging â†’ Governance violation â†’ Block merge
#   - Infrastructure failures â†’ Explicit infra-failure signal â†’ Retry + Comment
# Timeout: 15 minutes (sufficient for test suite + npm install)
# See: .github/CI_CLASSIFICATION.md

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

# Explicit, least-privilege permissions
# Required for governance feedback (PR comments, issues)
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build-to-green:
    name: Enforce Build-to-Green
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Documentation-Only PR
        id: detect-doc-only
        run: |
          echo "ðŸ” Detecting PR type..."
          
          # Get changed files (fetch main for comparison)
          git fetch origin main --depth=50 2>/dev/null || echo "Note: Could not fetch main branch"
          
          # Get list of changed files
          if git rev-parse origin/main >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD || echo "")
          else
            # Fallback: check current commit changes only
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD || echo "")
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for code/workflow changes
          if echo "$CHANGED_FILES" | grep -qE '\.(js|ts|jsx|tsx|py)$|\.github/workflows/.*\.ya?ml$|package\.json$|tsconfig\.json$|tests/|__tests__/|\.test\.|\.spec\.'; then
            echo "doc_only=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ PR Type: Code/Workflow Changes"
          else
            echo "doc_only=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ PR Type: Documentation-Only"
          fi

      - name: Check Build Wave Phase
        id: phase-check
        run: |
          echo "ðŸ” Checking build wave phase..."
          
          PHASE_FILE=".github/build-wave-phase.json"
          
          if [ ! -f "$PHASE_FILE" ]; then
            echo "âš ï¸ Phase file not found. Defaulting to enforcement enabled."
            echo "enabled=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          ENABLED=$(jq -r '.build_to_green_enabled' "$PHASE_FILE")
          CURRENT_WAVE=$(jq -r '.current_wave' "$PHASE_FILE")
          WAVE_NAME=$(jq -r '.wave_name' "$PHASE_FILE")
          
          echo "Current Wave: $CURRENT_WAVE - $WAVE_NAME"
          echo "Build-to-Green Enabled: $ENABLED"
          
          if [ "$ENABLED" = "false" ]; then
            echo "â¸ï¸ Build-to-Green enforcement is PAUSED for $CURRENT_WAVE"
            echo "enabled=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Build-to-Green enforcement is ACTIVE"
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Python
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Node dependencies
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'false'
        run: npm ci

      - name: Install Python dependencies
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'false'
        id: pip-install
        run: |
          pip install -r requirements-test.txt || {
            echo "PIP_INSTALL_FAILED=true" >> $GITHUB_ENV
            echo "outcome=failure" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "outcome=success" >> $GITHUB_OUTPUT
      
      - name: Check pip install status
        if: steps.phase-check.outputs.enabled == 'true' && steps.pip-install.outputs.outcome == 'failure'
        run: |
          echo "::warning::pip install failed - Infrastructure Failure detected"
          echo "INFRA_FAILURE=dependency_installation" >> $GITHUB_ENV
          echo "INFRA_FAILURE_STEP=pip-install" >> $GITHUB_ENV

      - name: Enforce No Test Dodging
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'false'
        run: |
          echo "ðŸ” Scanning for forbidden test-dodging patterns..."

          # Search only in executable code files, excluding documentation and detection scripts
          if grep -r --line-number --include="*.py" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            --exclude="detect-test-debt.py" --exclude-dir=".git" --exclude-dir="node_modules" \
            -E "\.skip|\.(only)\b|jest\.skip|describe\.only|it\.only|\|\| true" .; then
            echo "âŒ Test dodging detected."
            echo "Use governed QA parking or DP-RED instead."
            exit 1
          fi

          echo "âœ… No test dodging patterns found."

      - name: Run Test Suite
        if: steps.phase-check.outputs.enabled == 'true' && steps.pip-install.outputs.outcome != 'failure' && steps.detect-doc-only.outputs.doc_only == 'false'
        id: test-run
        run: |
          echo "â–¶ï¸ Running test suite..."
          if timeout 600 npm test; then
            echo "TEST_RESULT=success" >> $GITHUB_ENV
            echo "outcome=success" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            echo "TEST_RESULT=failure" >> $GITHUB_ENV
            echo "TEST_FAILED=$EXIT_CODE" >> $GITHUB_ENV
            echo "outcome=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze Test Failure
        if: steps.phase-check.outputs.enabled == 'true' && steps.test-run.outputs.outcome == 'failure' && steps.detect-doc-only.outputs.doc_only == 'false'
        id: analyze-failure
        run: |
          if [ "$TEST_FAILED" = "124" ]; then
            echo "::warning::Test suite timeout detected - Infrastructure Failure"
            echo "INFRA_FAILURE=timeout" >> $GITHUB_ENV
            echo "INFRA_FAILURE_STEP=test-run" >> $GITHUB_ENV
            echo "failure_type=infrastructure" >> $GITHUB_OUTPUT
          elif [ -n "$TEST_FAILED" ] && [ "$TEST_FAILED" != "0" ]; then
            echo "Test suite failed with exit code $TEST_FAILED - Code Failure"
            echo "failure_type=code" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Tests passed"
            echo "failure_type=none" >> $GITHUB_OUTPUT
          fi

      - name: Check for RED tests
        if: steps.phase-check.outputs.enabled == 'true' && (steps.analyze-failure.outputs.failure_type == '' || steps.analyze-failure.outputs.failure_type == 'none' || steps.analyze-failure.outputs.failure_type == 'code') && steps.detect-doc-only.outputs.doc_only == 'false'
        run: |
          echo "ðŸ” Checking for RED test results..."

          if [ -f ./qa/design_phase/DP_RED_REGISTRY.json ]; then
            echo "â„¹ï¸ DP-RED registry found."

            PHASE_FILE="./qa/phase/current_phase.txt"

            if [ ! -f "$PHASE_FILE" ]; then
              echo "âŒ Phase file missing. Cannot determine QA phase."
              exit 1
            fi

            CURRENT_PHASE=$(cat "$PHASE_FILE")

            echo "Current phase: $CURRENT_PHASE"

            if [ "$CURRENT_PHASE" = "BUILD_TO_GREEN" ]; then
              echo "âŒ DP-RED present during Build-to-Green phase."
              exit 1
            fi

            echo "âœ… DP-RED allowed for current phase."
          else
            echo "â„¹ï¸ No DP-RED registry present."
          fi

      - name: Phase-Gated Enforcement Paused
        if: steps.phase-check.outputs.enabled == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const phaseData = JSON.parse(fs.readFileSync('.github/build-wave-phase.json', 'utf8'));
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              â¸ï¸ **Build-to-Green Enforcement PAUSED**
              
              **Current Wave**: ${phaseData.current_wave} - ${phaseData.wave_name}
              
              Build-to-Green enforcement is intentionally disabled during this phase.
              
              **Reason**: ${phaseData.description}
              
              Enforcement will be re-enabled in Wave 3.
              `
            })
      
      - name: Documentation-Only PR Handling
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              âœ… **Build-to-Green Enforcement - SKIP** (Documentation-Only PR)
              
              **Outcome**: Non-blocking SKIP  
              **Reason**: No code changes to test  
              **Status**: This gate does not block merge
              
              ---
              
              **Documentation-Only PR**: No code changes detected  
              **Test Execution**: Not required (no code to test)  
              **Test Dodging Check**: Not applicable (no test files modified)
              
              ---
              
              **Gate Status**: âœ… PASS (via informational skip)
              `
            })
      
      - name: Enforcement Paused - Success
        if: steps.phase-check.outputs.enabled == 'false'
        run: |
          echo "âœ… Build-to-Green Enforcement PAUSED - this is expected for current wave"
          echo "Workflow completes successfully (enforcement is paused, not failed)"
          exit 0
      
      - name: Documentation-Only PR Success
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'true'
        run: |
          echo "âœ… Build-to-Green Enforcement - SKIP (Documentation-Only PR)"
          echo "Status: Non-blocking, no code changes to test"
          exit 0

      - name: Governance Summary Comment
        if: steps.phase-check.outputs.enabled == 'true' && steps.detect-doc-only.outputs.doc_only == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              âœ… **Build-to-Green Check Completed**

              - No test dodging detected
              - Test suite executed
              - DP-RED handled according to governance rules

              âš ï¸ Reminder:
              - DP-RED must be cleared before Build-to-Green
              - All failures are treated as catastrophic until prevented permanently
              `
            })

      - name: Failure Handling
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Catastrophic Failure â€” Build-to-Green Enforcement",
              body: `
              âŒ **Catastrophic Failure Detected**

              This failure blocked Build-to-Green enforcement.

              Required actions:
              1. Pause work
              2. Identify root cause
              3. Implement permanent prevention
              4. Update QA and governance if required
              5. Propagate lessons learned to all repos

              Repeat occurrence of this failure is classified as **double-catastrophic**.
              `
            })
      
      - name: Generate Infrastructure Failure Report
        if: always() && env.INFRA_FAILURE != ''
        run: |
          mkdir -p /tmp/infra-failure
          cat > /tmp/infra-failure/report.json << 'EOF'
          {
            "failure_type": "infrastructure",
            "workflow": "build-to-green-enforcement",
            "job": "build-to-green",
            "failure_category": "${{ env.INFRA_FAILURE }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "step": "${{ env.INFRA_FAILURE_STEP }}",
            "retry_count": 0,
            "max_retries": 2,
            "recommended_action": "retry",
            "details": {
              "exit_code": "${{ env.TEST_FAILED }}",
              "workflow_run": "${{ github.run_id }}"
            }
          }
          EOF
          echo "ðŸ“Š Infrastructure failure report generated"
      
      - name: Upload Infrastructure Failure Artifact
        if: always() && env.INFRA_FAILURE != ''
        uses: actions/upload-artifact@v4
        with:
          name: infra-failure-report-build-to-green
          path: /tmp/infra-failure/report.json
          retention-days: 30
      
      - name: Comment Infrastructure Failure on PR
        if: always() && env.INFRA_FAILURE != '' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const failureType = process.env.INFRA_FAILURE;
            const failureStep = process.env.INFRA_FAILURE_STEP;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              âš ï¸ **Infrastructure Failure Detected**
              
              **Workflow**: Build-to-Green Enforcement  
              **Job**: build-to-green  
              **Failure Type**: \`${failureType}\`  
              **Step**: \`${failureStep}\`  
              **Timestamp**: ${new Date().toISOString()}
              
              This is **NOT a code failure**. The workflow encountered an infrastructure issue.
              
              **Actions Taken**:
              - Job will complete with success status (no code defect)
              - Infrastructure failure logged to artifact
              - Manual retry may be required if persistent
              
              **Failure Categories**:
              - \`timeout\`: Test suite exceeded timeout (10 minutes)
              - \`dependency_installation\`: npm/pip dependency installation failed
              - \`service_unavailable\`: GitHub Actions service issue
              
              **Next Steps**:
              1. Review infrastructure failure report artifact
              2. Retry workflow manually if needed
              3. If persistent across multiple retries, escalate to platform team
              4. **Your code changes are NOT blocked by this failure**
              
              **Infrastructure Failure Report**: Download artifact \`infra-failure-report-build-to-green\`
              
              ---
              
              **Reference**: See \`.github/CI_CLASSIFICATION.md\` for infrastructure failure handling protocol
              `
            })
      
      - name: Mark Success Despite Infrastructure Failure
        if: always() && env.INFRA_FAILURE != ''
        run: |
          echo "âœ… Job marked as success - Infrastructure failure (not code failure)"
          echo "Infrastructure failure type: $INFRA_FAILURE"
          echo "Infrastructure failure step: $INFRA_FAILURE_STEP"
          echo "This failure does NOT block merge - it is an infrastructure issue"
          exit 0
      
      - name: Workflow Success
        if: always() && (success() || steps.phase-check.outputs.enabled == 'false' || steps.detect-doc-only.outputs.doc_only == 'true')
        run: |
          DOC_ONLY="${{ steps.detect-doc-only.outputs.doc_only }}"
          
          if [ "$DOC_ONLY" = "true" ]; then
            echo "âœ… Build-to-Green Enforcement - SKIP (Documentation-Only PR)"
          elif [ "${{ steps.phase-check.outputs.enabled }}" = "false" ]; then
            echo "âœ… Build-to-Green Enforcement completed successfully (PAUSED for current wave)"
          else
            echo "âœ… Build-to-Green Enforcement completed successfully"
          fi
          exit 0
