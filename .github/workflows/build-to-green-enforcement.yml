name: Build-to-Green Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

# Explicit, least-privilege permissions
# Required for governance feedback (PR comments, issues)
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build-to-green:
    name: Enforce Build-to-Green
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Build Wave Phase
        id: phase-check
        run: |
          echo "üîç Checking build wave phase..."
          
          PHASE_FILE=".github/build-wave-phase.json"
          
          if [ ! -f "$PHASE_FILE" ]; then
            echo "‚ö†Ô∏è Phase file not found. Defaulting to enforcement enabled."
            echo "enabled=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          ENABLED=$(jq -r '.build_to_green_enabled' "$PHASE_FILE")
          CURRENT_WAVE=$(jq -r '.current_wave' "$PHASE_FILE")
          WAVE_NAME=$(jq -r '.wave_name' "$PHASE_FILE")
          
          echo "Current Wave: $CURRENT_WAVE - $WAVE_NAME"
          echo "Build-to-Green Enabled: $ENABLED"
          
          if [ "$ENABLED" = "false" ]; then
            echo "‚è∏Ô∏è Build-to-Green enforcement is PAUSED for $CURRENT_WAVE"
            echo "enabled=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Build-to-Green enforcement is ACTIVE"
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.phase-check.outputs.enabled == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Python
        if: steps.phase-check.outputs.enabled == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Node dependencies
        if: steps.phase-check.outputs.enabled == 'true'
        run: npm ci

      - name: Install Python dependencies
        if: steps.phase-check.outputs.enabled == 'true'
        run: pip install -r requirements-test.txt

      - name: Enforce No Test Dodging
        if: steps.phase-check.outputs.enabled == 'true'
        run: |
          echo "üîç Scanning for forbidden test-dodging patterns..."

          # Search only in executable code files, excluding documentation and detection scripts
          if grep -r --line-number --include="*.py" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            --exclude="detect-test-debt.py" --exclude-dir=".git" --exclude-dir="node_modules" \
            -E "\.skip|\.(only)\b|jest\.skip|describe\.only|it\.only|\|\| true" .; then
            echo "‚ùå Test dodging detected."
            echo "Use governed QA parking or DP-RED instead."
            exit 1
          fi

          echo "‚úÖ No test dodging patterns found."

      - name: Run Test Suite
        if: steps.phase-check.outputs.enabled == 'true'
        run: |
          echo "‚ñ∂Ô∏è Running test suite..."
          npm test

      - name: Check for RED tests
        if: steps.phase-check.outputs.enabled == 'true'
        run: |
          echo "üîç Checking for RED test results..."

          if [ -f ./qa/design_phase/DP_RED_REGISTRY.json ]; then
            echo "‚ÑπÔ∏è DP-RED registry found."

            PHASE_FILE="./qa/phase/current_phase.txt"

            if [ ! -f "$PHASE_FILE" ]; then
              echo "‚ùå Phase file missing. Cannot determine QA phase."
              exit 1
            fi

            CURRENT_PHASE=$(cat "$PHASE_FILE")

            echo "Current phase: $CURRENT_PHASE"

            if [ "$CURRENT_PHASE" = "BUILD_TO_GREEN" ]; then
              echo "‚ùå DP-RED present during Build-to-Green phase."
              exit 1
            fi

            echo "‚úÖ DP-RED allowed for current phase."
          else
            echo "‚ÑπÔ∏è No DP-RED registry present."
          fi

      - name: Phase-Gated Enforcement Paused
        if: steps.phase-check.outputs.enabled == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const phaseData = JSON.parse(fs.readFileSync('.github/build-wave-phase.json', 'utf8'));
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚è∏Ô∏è **Build-to-Green Enforcement PAUSED**
              
              **Current Wave**: ${phaseData.current_wave} - ${phaseData.wave_name}
              
              Build-to-Green enforcement is intentionally disabled during this phase.
              
              **Reason**: ${phaseData.description}
              
              Enforcement will be re-enabled in Wave 3.
              `
            })

      - name: Governance Summary Comment
        if: steps.phase-check.outputs.enabled == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚úÖ **Build-to-Green Check Completed**

              - No test dodging detected
              - Test suite executed
              - DP-RED handled according to governance rules

              ‚ö†Ô∏è Reminder:
              - DP-RED must be cleared before Build-to-Green
              - All failures are treated as catastrophic until prevented permanently
              `
            })

      - name: Failure Handling
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Catastrophic Failure ‚Äî Build-to-Green Enforcement",
              body: `
              ‚ùå **Catastrophic Failure Detected**

              This failure blocked Build-to-Green enforcement.

              Required actions:
              1. Pause work
              2. Identify root cause
              3. Implement permanent prevention
              4. Update QA and governance if required
              5. Propagate lessons learned to all repos

              Repeat occurrence of this failure is classified as **double-catastrophic**.
              `
            })
