name: Build-to-Green Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

# Grant permissions for PR comments and issue interactions
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Stage 1: Detect Test Debt
  test-debt-detection:
    name: Enforce Zero Test Debt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-mock

      - name: Detect Test Debt
        run: |
          echo "üîç Scanning for test debt..."
          python foreman/scripts/detect-test-debt.py --test-dir tests --json > test-debt-report.json
          
          # Check exit code
          if [ $? -ne 0 ]; then
            echo "‚ùå TEST DEBT DETECTED"
            cat test-debt-report.json
            echo "::error::Test debt detected - build BLOCKED by Zero Test Debt Constitutional Rule"
            exit 1
          else
            echo "‚úÖ Zero test debt confirmed"
          fi

      - name: Upload Test Debt Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-debt-report
          path: test-debt-report.json
          if-no-files-found: warn

  # Stage 2: Validate 100% Pass Requirement
  qa-green-validation:
    name: Enforce 100% Pass Requirement
    runs-on: ubuntu-latest
    needs: test-debt-detection
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-mock

      - name: Validate QA Green (100% Pass)
        run: |
          echo "üîç Validating QA green status..."
          python foreman/scripts/validate-qa-green.py --test-dir tests --json > qa-green-report.json
          
          # Check exit code
          if [ $? -ne 0 ]; then
            echo "‚ùå QA NOT GREEN"
            cat qa-green-report.json
            echo "::error::QA validation failed - build BLOCKED by Governance Supremacy Rule"
            exit 1
          else
            echo "‚úÖ QA is GREEN (100% pass)"
          fi

      - name: Upload QA Green Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-green-report
          path: qa-green-report.json
          if-no-files-found: warn

  # Stage 3: Check for Suppressed Failures
  suppression-check:
    name: Enforce No Suppressed Failures
    runs-on: ubuntu-latest
    needs: qa-green-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-mock

      - name: Check for Suppressed Failures
        run: |
          echo "üîç Checking for suppressed failures..."
          
          # Run tests with strict settings
          python -m pytest tests/ -v --strict-markers --strict-config -W error 2>&1 | tee suppression-check.log
          
          # Check exit code
          if [ $? -ne 0 ]; then
            echo "‚ùå SUPPRESSED FAILURES DETECTED"
            echo "::error::Suppressed failures found - build BLOCKED"
            exit 1
          else
            echo "‚úÖ No suppressed failures"
          fi

      - name: Upload Suppression Check Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: suppression-check-log
          path: suppression-check.log
          if-no-files-found: warn

  # Stage 4: Constitutional Compliance Check
  constitutional-compliance:
    name: Enforce Constitutional Compliance
    runs-on: ubuntu-latest
    needs: suppression-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Constitutional Files Integrity
        run: |
          echo "üîç Verifying constitutional file integrity..."
          
          # List of protected constitutional files
          CONSTITUTIONAL_FILES=(
            "BUILD_PHILOSOPHY.md"
            "foreman/constitution/"
            "foreman/governance/governance-supremacy-rule.md"
            "foreman/governance/zero-test-debt-constitutional-rule.md"
            "foreman/builder-specs/build-to-green-rule.md"
          )
          
          # Check if any constitutional files were modified
          MODIFIED=false
          for file in "${CONSTITUTIONAL_FILES[@]}"; do
            if git diff --name-only ${{ github.event.pull_request.base.sha || 'HEAD~1' }} ${{ github.sha }} | grep -q "^$file"; then
              echo "‚ö†Ô∏è  Constitutional file modified: $file"
              MODIFIED=true
            fi
          done
          
          if [ "$MODIFIED" = true ]; then
            echo "::warning::Constitutional files modified - Owner review required"
          fi
          
          echo "‚úÖ Constitutional compliance check complete"

      - name: Create Compliance Report
        run: |
          cat > constitutional-compliance.json << EOF
          {
            "success": true,
            "message": "Constitutional compliance verified",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "checks": [
              "Protected files integrity",
              "Build philosophy adherence",
              "Governance rules enforcement"
            ]
          }
          EOF

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: constitutional-compliance-report
          path: constitutional-compliance.json

  # Stage 5: Final Report and PR Comment
  enforcement-report:
    name: Report Enforcement Status
    runs-on: ubuntu-latest
    needs: [test-debt-detection, qa-green-validation, suppression-check, constitutional-compliance]
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Final Report
        run: |
          echo "## üéØ Build-to-Green Enforcement Report" > enforcement-report.md
          echo "" >> enforcement-report.md
          echo "**Status**: ‚úÖ PASSED" >> enforcement-report.md
          echo "" >> enforcement-report.md
          echo "### Constitutional Requirements Met:" >> enforcement-report.md
          echo "- ‚úÖ Zero test debt (no skip, todo, or only markers)" >> enforcement-report.md
          echo "- ‚úÖ 100% pass rate (all tests passing)" >> enforcement-report.md
          echo "- ‚úÖ No suppressed failures" >> enforcement-report.md
          echo "- ‚úÖ Constitutional compliance verified" >> enforcement-report.md
          echo "" >> enforcement-report.md
          echo "**Build approved for merge.**" >> enforcement-report.md

      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let reportContent = '‚úÖ **Build-to-Green Enforcement: PASSED**\n\n';
            reportContent += 'All constitutional requirements met:\n';
            reportContent += '- Zero test debt\n';
            reportContent += '- 100% pass rate\n';
            reportContent += '- No suppressed failures\n';
            reportContent += '- Full compliance\n\n';
            reportContent += '**Build approved for merge.**';
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reportContent
              });
            } catch (error) {
              core.warning('Failed to post comment: ' + error.message);
            }

  # Failure Handler: Report on any failures
  enforcement-failure:
    name: Report Enforcement Failure
    runs-on: ubuntu-latest
    needs: [test-debt-detection, qa-green-validation, suppression-check, constitutional-compliance]
    if: failure()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate Failure Report
        run: |
          echo "## ‚ùå Build-to-Green Enforcement FAILED" > failure-report.md
          echo "" >> failure-report.md
          echo "**Status**: BLOCKED" >> failure-report.md
          echo "" >> failure-report.md
          echo "### Violations Detected:" >> failure-report.md
          echo "" >> failure-report.md
          
          # Check which stage failed
          if [ -f "artifacts/test-debt-report/test-debt-report.json" ]; then
            echo "**Test Debt Report:**" >> failure-report.md
            cat artifacts/test-debt-report/test-debt-report.json >> failure-report.md
            echo "" >> failure-report.md
          fi
          
          if [ -f "artifacts/qa-green-report/qa-green-report.json" ]; then
            echo "**QA Green Report:**" >> failure-report.md
            cat artifacts/qa-green-report/qa-green-report.json >> failure-report.md
            echo "" >> failure-report.md
          fi
          
          echo "### Action Required:" >> failure-report.md
          echo "Fix all violations before merge. See reports above for details." >> failure-report.md

      - name: Comment Failure on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reportContent = '‚ùå **Build-to-Green Enforcement: FAILED**\n\n' +
              '**Build BLOCKED by Governance Supremacy Rule**\n\n' +
              'Violations detected. Please:\n' +
              '1. Check the workflow logs for details\n' +
              '2. Fix all failing tests\n' +
              '3. Remove any test debt (skip, todo, only)\n' +
              '4. Ensure 100% pass rate\n' +
              '5. Re-run the workflow\n\n' +
              'Download artifacts for detailed reports.';
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reportContent
              });
            } catch (error) {
              core.warning('Failed to post failure comment: ' + error.message);
            }
