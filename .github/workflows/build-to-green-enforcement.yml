name: Build-to-Green Enforcement

# Constitutional Authority: BUILD_PHILOSOPHY.md + Governance Supremacy Rule
# Purpose: Enforce true Build-to-Green semantics - no cheating allowed

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  enforce-zero-test-debt:
    name: "Enforce Zero Test Debt"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-mock
          
      - name: Detect Test Debt
        id: test_debt
        run: |
          echo "ðŸ” Scanning for test debt..."
          python foreman/scripts/detect-test-debt.py --test-dir tests --json > test-debt-report.json
          
          # Check exit code
          if [ $? -ne 0 ]; then
            echo "âŒ TEST DEBT DETECTED"
            cat test-debt-report.json
            echo "::error::Test debt detected - build BLOCKED by Zero Test Debt Constitutional Rule"
            exit 1
          else
            echo "âœ… No test debt detected"
          fi
          
      - name: Upload Test Debt Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-debt-report
          path: test-debt-report.json
          
  enforce-100-percent-pass:
    name: "Enforce 100% Pass Requirement"
    runs-on: ubuntu-latest
    needs: enforce-zero-test-debt
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-mock
          
      - name: Validate QA Green (100% Pass)
        id: qa_green
        run: |
          echo "ðŸ” Validating QA green status..."
          python foreman/scripts/validate-qa-green.py --test-dir tests --json > qa-green-report.json
          
          # Check exit code
          if [ $? -ne 0 ]; then
            echo "âŒ QA NOT GREEN"
            cat qa-green-report.json
            echo "::error::QA validation failed - build BLOCKED by Governance Supremacy Rule"
            exit 1
          else
            echo "âœ… QA is GREEN (100% pass)"
          fi
          
      - name: Upload QA Green Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-green-report
          path: qa-green-report.json
          
  enforce-no-suppressed-failures:
    name: "Enforce No Suppressed Failures"
    runs-on: ubuntu-latest
    needs: enforce-100-percent-pass
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-mock
          
      - name: Check for Suppressed Failures
        run: |
          echo "ðŸ” Checking for suppressed failures..."
          
          # Run tests with strict mode
          python -m pytest tests/ -v --strict-markers --tb=short -W error 2>&1 | tee test-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          
          # Check for any indication of suppressed failures
          if grep -qi "xfail\|xpass" test-output.txt; then
            echo "âŒ SUPPRESSED FAILURES DETECTED"
            echo "::error::Tests with xfail or xpass markers detected - not allowed"
            exit 1
          fi
          
          # Check for .only() in test files (should have been caught by test debt check)
          # Use -f to check if tests directory exists before searching
          if [ -d tests ]; then
            ONLY_MATCHES=$(find tests -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" \) -exec grep -l "\.only(" {} + || echo "")
            if [ -n "$ONLY_MATCHES" ]; then
              echo "âŒ FOCUSED TESTS DETECTED"
              echo "$ONLY_MATCHES"
              echo "::error::.only() tests detected - all tests must run"
              exit 1
            fi
          fi
          
          echo "âœ… No suppressed failures detected"
          exit $EXIT_CODE
          
  enforce-constitutional-compliance:
    name: "Enforce Constitutional Compliance"
    runs-on: ubuntu-latest
    needs: [enforce-zero-test-debt, enforce-100-percent-pass, enforce-no-suppressed-failures]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Verify Build Philosophy Compliance
        run: |
          echo "ðŸ” Verifying Build Philosophy compliance..."
          
          # Check that constitutional files have not been modified inappropriately
          PROTECTED_FILES=(
            "BUILD_PHILOSOPHY.md"
            "foreman/governance/governance-supremacy-rule.md"
            "foreman/governance/zero-test-debt-constitutional-rule.md"
            "foreman/builder-specs/build-to-green-rule.md"
          )
          
          for file in "${PROTECTED_FILES[@]}"; do
            if git diff --name-only origin/main...HEAD | grep -q "^$file$"; then
              echo "âš ï¸  Constitutional file modified: $file"
              echo "::warning::Constitutional file $file was modified - requires CS2 approval"
            fi
          done
          
          echo "âœ… Constitutional compliance verified"
          
      - name: Generate Enforcement Summary
        if: always()
        run: |
          echo "# Build-to-Green Enforcement Summary" > enforcement-summary.md
          echo "" >> enforcement-summary.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> enforcement-summary.md
          echo "**Commit**: ${{ github.sha }}" >> enforcement-summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> enforcement-summary.md
          echo "" >> enforcement-summary.md
          echo "## Enforcement Status" >> enforcement-summary.md
          echo "" >> enforcement-summary.md
          echo "- âœ… Zero Test Debt: Enforced" >> enforcement-summary.md
          echo "- âœ… 100% Pass Requirement: Enforced" >> enforcement-summary.md
          echo "- âœ… No Suppressed Failures: Enforced" >> enforcement-summary.md
          echo "- âœ… Constitutional Compliance: Verified" >> enforcement-summary.md
          echo "" >> enforcement-summary.md
          echo "## Constitutional Authority" >> enforcement-summary.md
          echo "" >> enforcement-summary.md
          echo "This enforcement is mandated by:" >> enforcement-summary.md
          echo "- BUILD_PHILOSOPHY.md (Supreme Authority)" >> enforcement-summary.md
          echo "- Governance Supremacy Rule" >> enforcement-summary.md
          echo "- Zero Test Debt Constitutional Rule" >> enforcement-summary.md
          echo "- Build to Green Rule" >> enforcement-summary.md
          echo "" >> enforcement-summary.md
          echo "**Green means GREEN. No exceptions. No compromises.**" >> enforcement-summary.md
          
          cat enforcement-summary.md
          
      - name: Upload Enforcement Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: enforcement-summary
          path: enforcement-summary.md
          
  report-enforcement-status:
    name: "Report Enforcement Status"
    runs-on: ubuntu-latest
    needs: [enforce-constitutional-compliance]
    if: always()
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        
      - name: Generate Final Report
        run: |
          echo "# Build-to-Green Enforcement - Final Report"
          echo ""
          echo "## Status: âœ… ALL ENFORCEMENTS PASSED"
          echo ""
          echo "This build has passed all Build-to-Green enforcement checks:"
          echo ""
          echo "1. âœ… Zero test debt verified"
          echo "2. âœ… 100% pass requirement met"
          echo "3. âœ… No suppressed failures"
          echo "4. âœ… Constitutional compliance verified"
          echo ""
          echo "**Build is APPROVED for merge.**"
          echo ""
          echo "---"
          echo "Enforced by: Build-to-Green Enforcement Workflow"
          echo "Authority: BUILD_PHILOSOPHY.md + Governance Supremacy Rule"
          
      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Build-to-Green Enforcement: PASSED**\n\nAll constitutional requirements met:\n- Zero test debt\n- 100% pass rate\n- No suppressed failures\n- Full compliance\n\n**Build approved for merge.**'
            })
