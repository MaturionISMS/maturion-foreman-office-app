name: Agent QA Boundary Enforcement

# CI CLASSIFICATION: Hard Gate
# Purpose: Enforces agent-scoped QA boundaries (Builder/FM/Governance QA separation)
# Failure Semantics:
#   - Wrong agent attribution â†’ Catastrophic governance violation â†’ Block merge + escalation
#   - Missing QA report (when expected) â†’ Advisory
#   - Infrastructure failures â†’ Explicit infra-failure signal â†’ Retry + Comment
# Timeout: 10 minutes (simple validation only)
# See: .github/CI_CLASSIFICATION.md

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

# Explicit, least-privilege permissions
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  enforce-agent-boundaries:
    name: Enforce Agent-Scoped QA Boundaries
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Find QA Reports in PR
        id: find-reports
        run: |
          echo "ðŸ” Searching for QA reports in repository..."
          
          # Find all QA report JSON files
          QA_REPORTS=$(find . -type f \( -name "*qa-report*.json" -o -name "*qa_report*.json" \) | tr '\n' ' ')
          
          if [ -z "$QA_REPORTS" ]; then
            echo "â„¹ï¸ No QA reports found in this PR"
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found QA reports: $QA_REPORTS"
            echo "reports=$QA_REPORTS" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate Agent Boundaries
        if: steps.find-reports.outputs.found == 'true'
        id: validate
        run: |
          echo "ðŸ”’ Validating agent-scoped QA boundaries..."
          
          if [ -f governance/scripts/validate_agent_boundaries.py ]; then
            if python governance/scripts/validate_agent_boundaries.py \
              --reports "${{ steps.find-reports.outputs.reports }}" \
              --current-repo "${{ github.repository }}"; then
              echo "outcome=success" >> $GITHUB_OUTPUT
            else
              echo "outcome=code_failure" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::Validation script not found - Infrastructure issue"
            echo "outcome=infra_failure" >> $GITHUB_OUTPUT
            echo "INFRA_FAILURE_TYPE=missing_validation_script" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Validation Result
        if: steps.find-reports.outputs.found == 'true'
        run: |
          OUTCOME="${{ steps.validate.outputs.outcome }}"
          echo "Validation outcome: $OUTCOME"
          
          if [ "$OUTCOME" = "code_failure" ]; then
            echo "âŒ Validation failed - code/governance issue"
            exit 1
          elif [ "$OUTCOME" = "infra_failure" ]; then
            echo "â„¹ï¸ Infrastructure failure detected - will report as success with commentary"
          else
            echo "âœ… Validation succeeded"
          fi
      
      - name: Report Success
        if: success() && steps.find-reports.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              âœ… **Agent QA Boundary Enforcement PASSED**
              
              All QA reports correctly attributed to appropriate agents:
              - Builder QA by Builder agents only âœ…
              - Governance QA by Governance agents only âœ…
              - FM QA by FM agents only âœ…
              
              No cross-agent QA execution detected.
              Agent-scoped QA boundaries respected.
              
              **Gatekeeper 1 approves governance compliance.**
              `
            })
      
      - name: No Reports Found
        if: steps.find-reports.outputs.found == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              â„¹ï¸ **Agent QA Boundary Enforcement - No Reports**
              
              No QA reports found in this PR.
              
              This is acceptable if:
              - This is a documentation-only change
              - This is a governance-only change
              - QA reports will be added in subsequent commits
              
              If QA reports are expected, ensure they are:
              - Named with pattern \`*qa-report*.json\` or \`*qa_report*.json\`
              - Committed to the repository
              - In JSON format with proper agent attribution
              `
            })
      
      - name: Report Infrastructure Failure
        if: always() && steps.validate.outputs.outcome == 'infra_failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const failureType = "${{ steps.validate.outputs.INFRA_FAILURE_TYPE }}" || "unknown";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              âš ï¸ **Infrastructure Failure Detected - Agent QA Boundary Enforcement**
              
              The Agent QA Boundary enforcement workflow encountered an infrastructure issue:
              
              **Failure Type**: \`${failureType}\`
              **Workflow Conclusion**: âœ… Success (with infrastructure caveat)
              
              ---
              
              ## What This Means
              
              - This is NOT a code or governance failure
              - The workflow cannot complete validation due to missing infrastructure components
              - **Merge is NOT blocked** by this workflow
              - Infrastructure issue requires attention but does not indicate code problems
              
              ---
              
              ## Required Action
              
              1. Review workflow logs for details
              2. Verify validation script exists at expected path
              3. Fix infrastructure issue in separate PR
              4. Re-run this workflow once infrastructure is fixed
              
              ---
              
              **Note**: Per WS4 infrastructure failure semantics, this workflow reports success with explicit commentary rather than blocking the PR on infrastructure issues.
              `
            })
      
      - name: Report Catastrophic Violation
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Create catastrophic failure issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ CATASTROPHIC: Agent QA Boundary Violation",
              labels: ['catastrophic-failure', 'governance-violation', 'requires-escalation'],
              body: `
              # CATASTROPHIC GOVERNANCE VIOLATION
              
              **Type**: Agent-Scoped QA Boundary Violation  
              **PR**: #${context.issue.number}  
              **Commit**: ${context.sha}  
              **Detected**: ${new Date().toISOString()}
              
              ---
              
              ## Violation
              
              Agent-scoped QA boundary violation detected in PR #${context.issue.number}.
              
              This is a **catastrophic governance violation** that breaks fundamental separation of duties in QA execution.
              
              ---
              
              ## Possible Causes
              
              - âŒ Builder agent executed Governance QA
              - âŒ Governance agent executed Builder QA
              - âŒ FM agent executed Builder QA
              - âŒ QA report missing agent attribution
              - âŒ QA report attributed to wrong agent
              
              ---
              
              ## REQUIRED ACTIONS (Mandatory)
              
              1. â›” **HALT** all related work immediately
              2. ðŸ” **IDENTIFY** which agent executed wrong QA scope
              3. ðŸ—‘ï¸ **REMOVE** violating QA report(s)
              4. âœ… **EXECUTE** QA in correct agent scope
              5. ðŸ“ **UPDATE** agent contract to prevent recurrence
              6. â¬†ï¸ **ESCALATE** to @JohanRas788 (Owner)
              
              ---
              
              ## Impact
              
              - Merge **BLOCKED** until violation resolved
              - PR cannot proceed
              - Root cause analysis **MANDATORY**
              - Prevention measures **REQUIRED**
              
              ---
              
              ## References
              
              - [Agent-Scoped QA Boundaries](../governance/alignment/AGENT_SCOPED_QA_BOUNDARIES.md)
              - [Two-Gatekeeper Model](../governance/alignment/TWO_GATEKEEPER_MODEL.md)
              - [PR Gate Failure Handling](../governance/alignment/PR_GATE_FAILURE_HANDLING_PROTOCOL.md)
              
              ---
              
              **Authority**: Corporate Governance Canon  
              **Enforcement**: Automatic (no override permitted)  
              **Escalation**: Mandatory to Owner
              `
            });
            
            // Comment on PR
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ðŸš¨ **CATASTROPHIC GOVERNANCE VIOLATION**
              
              Agent-scoped QA boundary violation detected.
              
              This is a **catastrophic governance violation** requiring immediate escalation.
              
              **Catastrophic Failure Issue Created**: #${issue.data.number}
              
              ---
              
              ## REQUIRED ACTIONS
              
              1. â›” HALT all related work
              2. ðŸ” Review workflow logs for violation details
              3. ðŸ—‘ï¸ Remove violating QA report
              4. âœ… Execute QA in correct agent scope
              5. ðŸ“ Update agent contract
              6. â¬†ï¸ Escalate to @JohanRas788
              
              ---
              
              **Merge BLOCKED until violation resolved.**
              
              See issue #${issue.data.number} for full details.
              `
            });
      
      - name: Generate Infrastructure Failure Report
        if: always() && env.INFRA_FAILURE != ''
        run: |
          mkdir -p /tmp/infra-failure
          cat > /tmp/infra-failure/report.json << 'EOF'
          {
            "failure_type": "infrastructure",
            "workflow": "agent-boundary-gate",
            "job": "enforce-agent-boundaries",
            "failure_category": "${{ env.INFRA_FAILURE }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "recommended_action": "investigate",
            "details": {
              "workflow_run": "${{ github.run_id }}"
            }
          }
          EOF
      
      - name: Upload Infrastructure Failure Artifact
        if: always() && env.INFRA_FAILURE != ''
        uses: actions/upload-artifact@v4
        with:
          name: infra-failure-report-agent-boundary
          path: /tmp/infra-failure/report.json
          retention-days: 30
      
      - name: Comment Infrastructure Failure on PR
        if: always() && env.INFRA_FAILURE != '' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const failureType = process.env.INFRA_FAILURE;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              âš ï¸ **Infrastructure Failure Detected**
              
              **Workflow**: Agent QA Boundary Enforcement  
              **Failure Type**: \`${failureType}\`  
              **Timestamp**: ${new Date().toISOString()}
              
              This is **NOT a code/governance failure**. The workflow encountered an infrastructure issue.
              
              **Possible Causes**:
              - Validation script missing or moved
              - File system access issues
              
              **Actions Taken**:
              - Job marked as success (no code defect)
              - Infrastructure failure logged
              
              **Your code changes are NOT blocked by this failure**
              
              **Infrastructure Failure Report**: Download artifact \`infra-failure-report-agent-boundary\`
              `
            })
      
      - name: Mark Success Despite Infrastructure Failure
        if: always() && env.INFRA_FAILURE != ''
        run: |
          echo "âœ… Job marked as success - Infrastructure failure (not code failure)"
          exit 0
      
      - name: Workflow Success
        if: always() && (success() || env.INFRA_FAILURE != '')
        run: |
          if [ -n "$INFRA_FAILURE" ]; then
            echo "âœ… Agent QA Boundary Enforcement completed successfully (infrastructure failure handled)"
          else
            echo "âœ… Agent QA Boundary Enforcement completed successfully"
          fi
          exit 0
