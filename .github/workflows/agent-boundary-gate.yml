name: Agent QA Boundary Enforcement

# CI CLASSIFICATION: Hard Gate
# Purpose: Enforces agent-scoped QA boundaries (Builder/FM/Governance QA separation)
# Failure Semantics:
#   - Wrong agent attribution ‚Üí Catastrophic governance violation ‚Üí Block merge + escalation
#   - Missing QA report (when expected) ‚Üí Advisory
#   - Infrastructure failures ‚Üí Explicit infra-failure signal ‚Üí Retry + Comment
# Timeout: 10 minutes (simple validation only)
# See: .github/CI_CLASSIFICATION.md

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

# Explicit, least-privilege permissions
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  enforce-agent-boundaries:
    name: Enforce Agent-Scoped QA Boundaries
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Find QA Reports in PR
        id: find-reports
        run: |
          echo "üîç Searching for QA reports in repository..."
          
          # Find all QA report JSON files
          QA_REPORTS=$(find . -type f \( -name "*qa-report*.json" -o -name "*qa_report*.json" \) | tr '\n' ' ')
          
          if [ -z "$QA_REPORTS" ]; then
            echo "‚ÑπÔ∏è No QA reports found in this PR"
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found QA reports: $QA_REPORTS"
            echo "reports=$QA_REPORTS" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate Agent Boundaries
        if: steps.find-reports.outputs.found == 'true'
        id: validate
        run: |
          echo "üîí Validating agent-scoped QA boundaries..."
          
          if [ -f governance/scripts/validate_agent_boundaries.py ]; then
            if python governance/scripts/validate_agent_boundaries.py \
              --reports "${{ steps.find-reports.outputs.reports }}" \
              --current-repo "${{ github.repository }}"; then
              echo "outcome=success" >> $GITHUB_OUTPUT
            else
              echo "outcome=code_failure" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::Validation script not found - Infrastructure issue"
            echo "outcome=infra_failure" >> $GITHUB_OUTPUT
            echo "infra_failure_type=missing_validation_script" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Validation Result
        if: steps.find-reports.outputs.found == 'true'
        run: |
          OUTCOME="${{ steps.validate.outputs.outcome }}"
          echo "Validation outcome: $OUTCOME"
          
          if [ "$OUTCOME" = "code_failure" ]; then
            echo "‚ùå Validation failed - code/governance issue"
            exit 1
          elif [ "$OUTCOME" = "infra_failure" ]; then
            echo "‚ÑπÔ∏è Infrastructure failure detected - will report as success with commentary"
          else
            echo "‚úÖ Validation succeeded"
          fi
      
      - name: Report Success
        if: success() && steps.find-reports.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚úÖ **Agent QA Boundary Enforcement PASSED**
              
              All QA reports correctly attributed to appropriate agents:
              - Builder QA by Builder agents only ‚úÖ
              - Governance QA by Governance agents only ‚úÖ
              - FM QA by FM agents only ‚úÖ
              
              No cross-agent QA execution detected.
              Agent-scoped QA boundaries respected.
              
              **Gatekeeper 1 approves governance compliance.**
              `
            })
      
      - name: No Reports Found
        if: steps.find-reports.outputs.found == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚ÑπÔ∏è **Agent QA Boundary Enforcement - No Reports**
              
              No QA reports found in this PR.
              
              This is acceptable if:
              - This is a documentation-only change
              - This is a governance-only change
              - QA reports will be added in subsequent commits
              
              If QA reports are expected, ensure they are:
              - Named with pattern \`*qa-report*.json\` or \`*qa_report*.json\`
              - Committed to the repository
              - In JSON format with proper agent attribution
              `
            })
      
      - name: Report Infrastructure Failure
        if: always() && steps.validate.outputs.outcome == 'infra_failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const failureType = "${{ steps.validate.outputs.infra_failure_type }}" || "unknown";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ‚ö†Ô∏è **Infrastructure Failure Detected - Agent QA Boundary Enforcement**
              
              The Agent QA Boundary enforcement workflow encountered an infrastructure issue:
              
              **Failure Type**: \`${failureType}\`
              **Workflow Conclusion**: ‚úÖ Success (with infrastructure caveat)
              
              ---
              
              ## What This Means
              
              - This is NOT a code or governance failure
              - The workflow cannot complete validation due to missing infrastructure components
              - **Merge is NOT blocked** by this workflow
              - Infrastructure issue requires attention but does not indicate code problems
              
              ---
              
              ## Required Action
              
              1. Review workflow logs for details
              2. Verify validation script exists at expected path
              3. Fix infrastructure issue in separate PR
              4. Re-run this workflow once infrastructure is fixed
              
              ---
              
              **Note**: Per WS4 infrastructure failure semantics, this workflow reports success with explicit commentary rather than blocking the PR on infrastructure issues.
              `
            })
      
      - name: Report Catastrophic Violation
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Create catastrophic failure issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "üö® CATASTROPHIC: Agent QA Boundary Violation",
              labels: ['catastrophic-failure', 'governance-violation', 'requires-escalation'],
              body: `
              # CATASTROPHIC GOVERNANCE VIOLATION
              
              **Type**: Agent-Scoped QA Boundary Violation  
              **PR**: #${context.issue.number}  
              **Commit**: ${context.sha}  
              **Detected**: ${new Date().toISOString()}
              
              ---
              
              ## Violation
              
              Agent-scoped QA boundary violation detected in PR #${context.issue.number}.
              
              This is a **catastrophic governance violation** that breaks fundamental separation of duties in QA execution.
              
              ---
              
              ## Possible Causes
              
              - ‚ùå Builder agent executed Governance QA
              - ‚ùå Governance agent executed Builder QA
              - ‚ùå FM agent executed Builder QA
              - ‚ùå QA report missing agent attribution
              - ‚ùå QA report attributed to wrong agent
              
              ---
              
              ## REQUIRED ACTIONS (Mandatory)
              
              1. ‚õî **HALT** all related work immediately
              2. üîç **IDENTIFY** which agent executed wrong QA scope
              3. üóëÔ∏è **REMOVE** violating QA report(s)
              4. ‚úÖ **EXECUTE** QA in correct agent scope
              5. üìù **UPDATE** agent contract to prevent recurrence
              6. ‚¨ÜÔ∏è **ESCALATE** to @JohanRas788 (Owner)
              
              ---
              
              ## Impact
              
              - Merge **BLOCKED** until violation resolved
              - PR cannot proceed
              - Root cause analysis **MANDATORY**
              - Prevention measures **REQUIRED**
              
              ---
              
              ## References
              
              - [Agent-Scoped QA Boundaries](../governance/alignment/AGENT_SCOPED_QA_BOUNDARIES.md)
              - [Two-Gatekeeper Model](../governance/alignment/TWO_GATEKEEPER_MODEL.md)
              - [PR Gate Failure Handling](../governance/alignment/PR_GATE_FAILURE_HANDLING_PROTOCOL.md)
              
              ---
              
              **Authority**: Corporate Governance Canon  
              **Enforcement**: Automatic (no override permitted)  
              **Escalation**: Mandatory to Owner
              `
            });
            
            // Comment on PR
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              üö® **CATASTROPHIC GOVERNANCE VIOLATION**
              
              Agent-scoped QA boundary violation detected.
              
              This is a **catastrophic governance violation** requiring immediate escalation.
              
              **Catastrophic Failure Issue Created**: #${issue.data.number}
              
              ---
              
              ## REQUIRED ACTIONS
              
              1. ‚õî HALT all related work
              2. üîç Review workflow logs for violation details
              3. üóëÔ∏è Remove violating QA report
              4. ‚úÖ Execute QA in correct agent scope
              5. üìù Update agent contract
              6. ‚¨ÜÔ∏è Escalate to @JohanRas788
              
              ---
              
              **Merge BLOCKED until violation resolved.**
              
              See issue #${issue.data.number} for full details.
              `
            });
      
      - name: Workflow Success
        if: always()
        run: |
          OUTCOME="${{ steps.validate.outputs.outcome }}"
          
          if [ "$OUTCOME" = "infra_failure" ]; then
            echo "‚úÖ Agent QA Boundary Enforcement completed successfully (infrastructure failure handled)"
          elif [ "$OUTCOME" = "code_failure" ]; then
            echo "‚ùå Agent QA Boundary Enforcement failed (code/governance violation)"
            exit 1
          elif [ -z "$OUTCOME" ]; then
            echo "‚úÖ Agent QA Boundary Enforcement completed successfully (no reports found - acceptable)"
          else
            echo "‚úÖ Agent QA Boundary Enforcement completed successfully"
          fi
          exit 0
