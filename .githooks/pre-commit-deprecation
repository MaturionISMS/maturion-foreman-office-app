#!/bin/bash
#
# Pre-commit Hook for Deprecation Detection (BL-026)
#
# Constitutional Authority: BL-026 Automated Deprecation Detection Gate
# Purpose: Prevent deprecated Python APIs from entering the repository
#
# Installation:
#   cp .githooks/pre-commit-deprecation .git/hooks/pre-commit-deprecation
#   chmod +x .git/hooks/pre-commit-deprecation
#   # Or run from main pre-commit hook
#

set -e

echo "üîç Deprecation Detection Gate (BL-026): Scanning for deprecated APIs..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if ruff is installed
if ! command -v ruff &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  ruff not found${NC}"
    echo "Installing ruff from requirements-test.txt..."
    if ! pip install -q ruff; then
        echo -e "${RED}‚ùå Failed to install ruff${NC}"
        echo "Please install manually: pip install ruff"
        exit 1
    fi
fi

# Get staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo "   No Python files staged for commit"
    echo -e "${GREEN}‚úÖ Deprecation check skipped (no Python changes)${NC}"
    echo ""
    exit 0
fi

echo "Checking staged Python files:"
for file in $STAGED_PY_FILES; do
    echo "  - $file"
done
echo ""

# Run ruff on staged files
echo "Running ruff deprecation detection..."
VIOLATIONS_FOUND=0

# Create temporary file for results
TEMP_RESULTS=$(mktemp)

# Run ruff check with UP rules only
if ! ruff check --select UP $STAGED_PY_FILES > "$TEMP_RESULTS" 2>&1; then
    VIOLATIONS_FOUND=1
fi

# Check if violations were found
if [ $VIOLATIONS_FOUND -eq 1 ]; then
    echo -e "${RED}‚ùå DEPRECATED API USAGE DETECTED${NC}"
    echo ""
    cat "$TEMP_RESULTS"
    echo ""
    echo -e "${RED}Commit BLOCKED by BL-026 Deprecation Detection Gate${NC}"
    echo ""
    echo "Common deprecated patterns to fix:"
    echo "  ‚Ä¢ datetime.utcnow() ‚Üí datetime.now(timezone.utc)"
    echo "  ‚Ä¢ datetime.utcfromtimestamp(ts) ‚Üí datetime.fromtimestamp(ts, tz=timezone.utc)"
    echo "  ‚Ä¢ typing.List[X] ‚Üí list[X] (Python 3.9+)"
    echo "  ‚Ä¢ typing.Dict[K,V] ‚Üí dict[K,V] (Python 3.9+)"
    echo ""
    echo "To fix automatically where possible:"
    echo "  ruff check --select UP --fix $STAGED_PY_FILES"
    echo ""
    echo "For justified exceptions (rare), see:"
    echo "  governance/policies/AUTOMATED_DEPRECATION_DETECTION_GATE.md"
    echo ""
    rm -f "$TEMP_RESULTS"
    exit 1
fi

rm -f "$TEMP_RESULTS"

echo -e "${GREEN}‚úÖ No deprecated APIs detected${NC}"
echo ""

exit 0
